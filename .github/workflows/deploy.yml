name: Deploy to VPS

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-backend
  cancel-in-progress: true

env:
  APP_BASE_URL: https://app2.andrepombo.info

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      env:
        ENV: ${{ secrets.ENV }}
        DEBUG: ${{ secrets.DEBUG }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
        CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
        TIME_ZONE: ${{ secrets.TIME_ZONE }}
        LANGUAGE_CODE: ${{ secrets.LANGUAGE_CODE }}
      run: |
        echo "ENV=$ENV" >> .env
        echo "DEBUG=$DEBUG" >> .env
        echo "DEMO_MODE=True" >> .env

        # echo "SECRET_KEY=$SECRET_KEY" >> .env
        # echo "ALLOWED_HOSTS=$ALLOWED_HOSTS" >> .env
        # echo "CORS_ALLOWED_ORIGINS=$CORS_ALLOWED_ORIGINS" >> .env
        # echo "TIME_ZONE=$TIME_ZONE" >> .env
        # echo "LANGUAGE_CODE=$LANGUAGE_CODE" >> .env

    - name: Copy files to VPS
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        ARGS: "-rlgoDzvc -i"
        SOURCE: "./"
        REMOTE_HOST: ${{ secrets.VPS_HOST }}
        REMOTE_USER: ${{ secrets.VPS_SSH_USER }}
        TARGET: '/home/${{ secrets.VPS_SSH_USER }}/apps/app2/backend'
        EXCLUDE: "/dist/, /node_modules/, /.git/, /venv/, /__pycache__/, *.pyc"
        SCRIPT_AFTER: |
          echo "Files copied successfully"

    - name: Build and start containers
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_SSH_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Build and start only the backend service from the main app2 stack
          cd /home/${{ secrets.VPS_SSH_USER }}/apps/app2

          echo "Building and starting backend container..."
          docker compose up -d --build backend

          echo "Waiting for services to start..."
          sleep 30

          echo "Checking container status for backend..."
          docker compose ps backend

          echo "Deployment completed successfully!"

    - name: Health check
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_SSH_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /home/${{ secrets.VPS_SSH_USER }}/apps/app2
          echo "Performing backend health check via public API endpoint..."
          sleep 10

          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.APP_BASE_URL }}/api/ || echo "000")
          echo "Health check HTTP status: $STATUS_CODE"

          if [ "$STATUS_CODE" = "200" ] || [ "$STATUS_CODE" = "401" ]; then
            echo "‚úÖ API endpoint is responding (status $STATUS_CODE)"
          else
            echo "‚ö†Ô∏è  API endpoint check failed (status $STATUS_CODE)"
            docker compose logs backend --tail=50
            exit 1
          fi

          echo "\nBackend container status:"
          docker compose ps backend

          echo "\nRecent backend logs:"
          docker compose logs backend --tail=20

          echo "\nüéâ Deployment health check completed!"
          echo "Your application should be accessible at: ${{ env.APP_BASE_URL }}"
